package br.fai.lds.backend.implementation.repository;import br.fai.lds.backend.usecases.port.FavoritoRepository;import br.fai.lds.backend.implementation.repository.connection.ConnectionFactory;import br.fai.lds.domain.FavoritoModel;import java.sql.*;import java.util.ArrayList;import java.util.List;public class FavoritoDaoPostgres implements FavoritoRepository {    private final String TABLE = "favorito";    @Override    public List<FavoritoModel> findAll() {        List<FavoritoModel> lista = new ArrayList<>();        String sql =                "SELECT f.id, f.id_usuario, f.id_medicamento, f.data_cadastro, " +                        "COALESCE(m.nome, 'Medicamento desconhecido') AS medicamento_nome, " +                        "COALESCE(m.principio_ativo, 'Não informado') AS principio_ativo, " +                        "COALESCE(fa.nome_fantasia, 'Farmácia não cadastrada') AS farmacia_nome, " +                        "CASE WHEN e.quantidade > 0 THEN TRUE ELSE FALSE END AS disponivel " +                        "FROM favorito f " +                        "LEFT JOIN medicamento m ON m.id = f.id_medicamento " +                        "LEFT JOIN estoque e ON e.id_medicamento = m.id " +                        "LEFT JOIN farmacia fa ON fa.id = e.id_farmacia " +                        "ORDER BY f.data_cadastro DESC;";        try (Connection con = ConnectionFactory.getConnection();             PreparedStatement pst = con.prepareStatement(sql);             ResultSet rs = pst.executeQuery()) {            while (rs.next()) {                FavoritoModel f = new FavoritoModel();                f.setId(rs.getLong("id"));                f.setIdUsuario(rs.getLong("id_usuario"));                f.setIdMedicamento(rs.getLong("id_medicamento"));                f.setDataCadastro(rs.getTimestamp("data_cadastro").toLocalDateTime());                f.setMedicamentoNome(rs.getString("medicamento_nome"));                f.setPrincipioAtivo(rs.getString("principio_ativo"));                f.setFarmaciaNome(rs.getString("farmacia_nome"));                f.setDisponivel(rs.getBoolean("disponivel"));                lista.add(f);            }        } catch (SQLException ex) {            ex.printStackTrace();        }        return lista;    }    @Override    public FavoritoModel findById(Long id) {        String sql =                "SELECT f.id, f.id_usuario, f.id_medicamento, f.data_cadastro, " +                        "COALESCE(m.nome, 'Medicamento desconhecido') AS medicamento_nome, " +                        "COALESCE(m.principio_ativo, 'Não informado') AS principio_ativo, " +                        "COALESCE(fa.nome_fantasia, 'Farmácia não cadastrada') AS farmacia_nome, " +                        "CASE WHEN e.quantidade > 0 THEN TRUE ELSE FALSE END AS disponivel " +                        "FROM favorito f " +                        "LEFT JOIN medicamento m ON m.id = f.id_medicamento " +                        "LEFT JOIN estoque e ON e.id_medicamento = m.id " +                        "LEFT JOIN farmacia fa ON fa.id = e.id_farmacia " +                        "WHERE f.id = ?;";        try (Connection con = ConnectionFactory.getConnection();             PreparedStatement pst = con.prepareStatement(sql)) {            pst.setLong(1, id);            try (ResultSet rs = pst.executeQuery()) {                if (rs.next()) {                    FavoritoModel f = new FavoritoModel();                    f.setId(rs.getLong("id"));                    f.setIdUsuario(rs.getLong("id_usuario"));                    f.setIdMedicamento(rs.getLong("id_medicamento"));                    f.setDataCadastro(rs.getTimestamp("data_cadastro").toLocalDateTime());                    f.setMedicamentoNome(rs.getString("medicamento_nome"));                    f.setPrincipioAtivo(rs.getString("principio_ativo"));                    f.setFarmaciaNome(rs.getString("farmacia_nome"));                    f.setDisponivel(rs.getBoolean("disponivel"));                    return f;                }            }        } catch (SQLException ex) {            ex.printStackTrace();        }        return null;    }    @Override    public List<FavoritoModel> findByUsuarioId(Long usuarioId) {        List<FavoritoModel> lista = new ArrayList<>();        String sql =                "SELECT f.id, f.id_usuario, f.id_medicamento, f.data_cadastro, " +                        "COALESCE(m.nome, 'Medicamento desconhecido') AS medicamento_nome, " +                        "COALESCE(m.principio_ativo, 'Não informado') AS principio_ativo, " +                        "COALESCE(fa.nome_fantasia, 'Farmácia não cadastrada') AS farmacia_nome, " +                        "CASE WHEN e.quantidade > 0 THEN TRUE ELSE FALSE END AS disponivel " +                        "FROM favorito f " +                        "LEFT JOIN medicamento m ON m.id = f.id_medicamento " +                        "LEFT JOIN estoque e ON e.id_medicamento = m.id " +                        "LEFT JOIN farmacia fa ON fa.id = e.id_farmacia " +                        "WHERE f.id_usuario = ? " +                        "ORDER BY f.data_cadastro DESC;";        try (Connection con = ConnectionFactory.getConnection();             PreparedStatement pst = con.prepareStatement(sql)) {            pst.setLong(1, usuarioId);            try (ResultSet rs = pst.executeQuery()) {                while (rs.next()) {                    FavoritoModel f = new FavoritoModel();                    f.setId(rs.getLong("id"));                    f.setIdUsuario(rs.getLong("id_usuario"));                    f.setIdMedicamento(rs.getLong("id_medicamento"));                    f.setDataCadastro(rs.getTimestamp("data_cadastro").toLocalDateTime());                    f.setMedicamentoNome(rs.getString("medicamento_nome"));                    f.setPrincipioAtivo(rs.getString("principio_ativo"));                    f.setFarmaciaNome(rs.getString("farmacia_nome"));                    f.setDisponivel(rs.getBoolean("disponivel"));                    lista.add(f);                }            }        } catch (SQLException ex) {            ex.printStackTrace();        }        return lista;    }    @Override    public FavoritoModel create(FavoritoModel favorito) {        String sql = "INSERT INTO " + TABLE + " (id_usuario, id_medicamento) VALUES (?, ?) RETURNING id";        try (Connection con = ConnectionFactory.getConnection();             PreparedStatement pst = con.prepareStatement(sql)) {            pst.setLong(1, favorito.getIdUsuario());            pst.setLong(2, favorito.getIdMedicamento());            try (ResultSet rs = pst.executeQuery()) {                if (rs.next()) {                    favorito.setId(rs.getLong("id"));                    return favorito;                }            }        } catch (SQLException ex) {            ex.printStackTrace();        }        return null;    }    @Override    public boolean delete(Long id) {        String sql = "DELETE FROM " + TABLE + " WHERE id = ?";        try (Connection con = ConnectionFactory.getConnection();             PreparedStatement pst = con.prepareStatement(sql)) {            pst.setLong(1, id);            return pst.executeUpdate() > 0;        } catch (SQLException ex) {            ex.printStackTrace();        }        return false;    }    @Override    public boolean deleteByUsuarioAndMedicamento(Long usuarioId, Long medicamentoId) {        String sql = "DELETE FROM " + TABLE + " WHERE id_usuario = ? AND id_medicamento = ?";        try (Connection con = ConnectionFactory.getConnection();             PreparedStatement pst = con.prepareStatement(sql)) {            pst.setLong(1, usuarioId);            pst.setLong(2, medicamentoId);            return pst.executeUpdate() > 0;        } catch (SQLException ex) {            ex.printStackTrace();        }        return false;    }}